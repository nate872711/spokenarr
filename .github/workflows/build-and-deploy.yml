name: üöÄ Build & Deploy Spokenarr (API + Web)

on:
  workflow_dispatch:  # manual trigger
  push:
    branches:
      - main
    paths:
      - "frontend/**"
      - "backend/**"
      - ".github/workflows/build-and-deploy.yml"

jobs:
  build-and-push:
    name: üß± Build & Push Multi-Arch Images
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write

    env:
      DOCKERHUB_REPO_API: nate8727/spokenarr-api
      DOCKERHUB_REPO_WEB: nate8727/spokenarr-web

    steps:
      # -------------------------------
      # Setup
      # -------------------------------
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      - name: üß© Setup QEMU (multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: üß± Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # -------------------------------
      # Cache layers (shared for API + Web)
      # -------------------------------
      - name: üíæ Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # -------------------------------
      # Build Backend API
      # -------------------------------
      - name: üêç Build & Push API Image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.DOCKERHUB_REPO_API }}:latest
            ${{ env.DOCKERHUB_REPO_API }}:${{ github.run_number }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new

      # -------------------------------
      # Build Frontend Web
      # -------------------------------
      - name: üåê Build & Push Web Image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.DOCKERHUB_REPO_WEB }}:latest
            ${{ env.DOCKERHUB_REPO_WEB }}:${{ github.run_number }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new

      # -------------------------------
      # Move cache for next build
      # -------------------------------
      - name: ‚ôªÔ∏è Move Build Cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      # -------------------------------
      # Create Git Tag (optional)
      # -------------------------------
      - name: üè∑Ô∏è Create Git Tag
        if: success()
        run: |
          VERSION="v${{ github.run_number }}"
          git tag $VERSION
          git push origin $VERSION
