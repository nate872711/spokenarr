name: ğŸ§± Build, Push & Release Spokenarr

on:
  push:
    branches: [main]
  workflow_dispatch:

# âœ… This enables tag pushes & release creation
permissions:
  contents: write

env:
  DOCKERHUB_USER: nate8727
  DOCKERHUB_REPO_API: spokenarr-api
  DOCKERHUB_REPO_WEB: spokenarr-web

jobs:
  # -------------------------------
  # Backend API build & push
  # -------------------------------
  build-backend:
    name: ğŸ§± Build & Push Backend API
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§° Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: ğŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ·ï¸ Set version tag
        id: vars
        run: echo "tag=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

      - name: ğŸ”‘ Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ³ Build & Push Backend Image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.DOCKERHUB_USER }}/${{ env.DOCKERHUB_REPO_API }}:latest
            ${{ env.DOCKERHUB_USER }}/${{ env.DOCKERHUB_REPO_API }}:${{ steps.vars.outputs.tag }}
            ${{ env.DOCKERHUB_USER }}/${{ env.DOCKERHUB_REPO_API }}:${{ github.sha }}

  # -------------------------------
  # Frontend build & push
  # -------------------------------
  build-frontend:
    name: ğŸŒ Build & Push Web UI
    runs-on: ubuntu-latest
    needs: [build-backend]

    steps:
      - name: ğŸ§° Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: ğŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ·ï¸ Use tag from backend
        run: echo "TAG=${{ needs.build-backend.outputs.tag || 'v' }}$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV

      - name: ğŸ”‘ Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ³ Build & Push Web Image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.DOCKERHUB_USER }}/${{ env.DOCKERHUB_REPO_WEB }}:latest
            ${{ env.DOCKERHUB_USER }}/${{ env.DOCKERHUB_REPO_WEB }}:${{ env.TAG }}
            ${{ env.DOCKERHUB_USER }}/${{ env.DOCKERHUB_REPO_WEB }}:${{ github.sha }}

  # -------------------------------
  # GitHub Release
  # -------------------------------
  release:
    name: ğŸ·ï¸ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ§° Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Create Tag
        id: tag
        run: echo "tag=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

      - name: ğŸª„ Create Git Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.tag.outputs.tag }}
          git push origin ${{ steps.tag.outputs.tag }}

      - name: ğŸ§¾ Generate Changelog
        id: changelog
        run: |
          echo "changes<<EOF" >> $GITHUB_OUTPUT
          git log -1 --pretty=format:"%s%n%b" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸš€ Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "Spokenarr Release ${{ steps.tag.outputs.tag }}"
          body: |
            âœ… **Automated build completed successfully**

            ğŸ§± Backend: `${{ env.DOCKERHUB_USER }}/${{ env.DOCKERHUB_REPO_API }}:${{ steps.tag.outputs.tag }}`
            ğŸŒ Frontend: `${{ env.DOCKERHUB_USER }}/${{ env.DOCKERHUB_REPO_WEB }}:${{ steps.tag.outputs.tag }}`

            ğŸ” Latest commit:
            ```
            ${{ steps.changelog.outputs.changes }}
            ```
