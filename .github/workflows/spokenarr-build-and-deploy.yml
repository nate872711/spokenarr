name: ğŸ³ Build & Deploy Spokenarr (Full Stack)

on:
  push:
    branches: [ "main" ]
    paths:
      - "frontend/**"
      - "backend/**"
      - "docker-compose.yml"
      - ".github/workflows/spokenarr-build-and-deploy.yml"
  workflow_dispatch:

jobs:
  setup:
    name: âš™ï¸ Setup Environment
    runs-on: ubuntu-latest
    outputs:
      date: ${{ steps.date.outputs.date }}
    steps:
      - name: ğŸ§° Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“… Set Date Output
        id: date
        run: echo "date=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT

  # -------------------------------
  # Backend (FastAPI)
  # -------------------------------
  build-backend:
    name: ğŸ§± Build & Push Backend (FastAPI)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: ğŸ§° Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸª£ Warm Buildx Cache (Backend)
        run: |
          docker pull nate8727/spokenarr-api:cache || true

      - name: ğŸ§± Build & Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: nate8727/spokenarr-api:latest
          platforms: linux/amd64,linux/arm64
          cache-from: type=registry,ref=nate8727/spokenarr-api:cache
          cache-to: type=registry,ref=nate8727/spokenarr-api:cache,mode=max

  # -------------------------------
  # Frontend (React + Nginx)
  # -------------------------------
  build-frontend:
    name: ğŸŒ Build & Push Web UI (React)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: ğŸ§° Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸª£ Warm Buildx Cache (Frontend)
        run: |
          docker pull nate8727/spokenarr-web:cache || true

      - name: ğŸ§± Build & Push Web Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: nate8727/spokenarr-web:latest
          platforms: linux/amd64,linux/arm64
          cache-from: type=registry,ref=nate8727/spokenarr-web:cache
          cache-to: type=registry,ref=nate8727/spokenarr-web:cache,mode=max

  # -------------------------------
  # Deployment (optional)
  # -------------------------------
  deploy-stack:
    name: ğŸš€ Deploy Docker Stack
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ§° Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ³ Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: ğŸš€ Deploy Using docker-compose
        run: |
          docker compose down || true
          docker compose pull
          docker compose up -d
